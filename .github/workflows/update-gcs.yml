name: Upload or Update Files

on:
  push:
    branches:
      - main  # Trigger on commits to the main branch

jobs:
  upload-update-sh-files:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get changed .sh files
      id: changed-files
      run: |
        # List all .sh files that were added, modified, or renamed
        git diff --name-only --diff-filter=AMR HEAD^ HEAD | grep '\.sh$' > changed_files.txt || true
        cat changed_files.txt

    - name: Run job for .sh files only
      if: steps.changed-files.outputs.changed_files != ''
      run: |
        while IFS= read -r file; do
          echo "Processing $file..."
          if [ -f "$file" ]; then
            base_name=$(basename "$file")
            echo "Uploading $file as $base_name in GCS..."
            gsutil cp "$file" gs://cloudhustler/"$base_name"
          else
            echo "File $file does not exist locally. Skipping..."
          fi
        done < changed_files.txt

  upload-md-files-to-public-repo:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get changed .md files
      id: changed-md-files
      run: |
        # List all .md files that were added, modified, or renamed
        git diff --name-only --diff-filter=AMR HEAD^ HEAD | grep '\.md$' > changed_md_files.txt || true
        cat changed_md_files.txt

    - name: Clone public repository
      run: |
        git clone https://github.com/Abhiraj-1604/cloudhustlerpublic.git cloudhustlerpublic
      env:
        PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}

    - name: Run job for .md files only
      if: steps.changed-md-files.outputs.changed_files != ''
      run: |
        cd cloudhustlerpublic
        while IFS= read -r file; do
          echo "Copying $file to the public repository..."
          cp "$file" cloudhustlerpublic/
        done < changed_md_files.txt

    - name: Commit and push changes to public repository
      run: |
        cd cloudhustlerpublic
        git add .  # Add all changes
        git commit -m "Update .md files"
        git push https://Abhiraj-1604:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/Abhiraj-1604/cloudhustlerpublic.git
      env:
        PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
